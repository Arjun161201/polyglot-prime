<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/prime}">

<head>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css">

    <!-- if JSON Viewer is not already in the layout, add the following -->
    <!-- <script src="https://unpkg.com/@alenaksu/json-viewer@2.0.0/dist/json-viewer.bundle.js"></script> -->

    <script src="https://unpkg.com/ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>
    <script type="module">
        import { AGGridAide, AGGridAideBuilder } from '@presentation/shell/aggrid-aide.js';
        import ModalAide from '@presentation/shell/modal-aide.js';

        const schemaName = 'techbd_udi_ingress';
        const viewName = 'orch_session_diagnostics';
        document.addEventListener('DOMContentLoaded', function () {
            const modalAide = new ModalAide('sftp');
            const agGridInstance = new AGGridAideBuilder()
                .withColumnDefs([
                    { headerName: "Request Time", field: "orch_started_at", sortable: true, sort: "desc", filter: "agNumberColumnFilter", headerTooltip: "Time at which the session started", valueFormatter: AGGridAide.dateTimeValueFormatter(false) },
                    { headerName: "QE", field: "qe", filter: "agTextColumnFilter", headerTooltip: "Name of the QE" },
                    { headerName: "Ingested File Source", field: "ingest_file", filter: "agTextColumnFilter", headerTooltip: "Name of the CSV file where the issue occured",tooltipValueGetter: (p) =>
                    p.value },
                    { headerName: "Issue Column", field: "issue_column", filter: "agTextColumnFilter", headerTooltip: "Affected Column" },
                    { headerName: "Issue Message", suppressSizeToFit: true, field: "issue_message", filter: "agTextColumnFilter",headerTooltip: "Issue Message", tooltipValueGetter: (p) =>
                    p.value},
                    { headerName: "Remediation", field: "remediation", filter: "agTextColumnFilter",tooltipValueGetter: (p) =>
                    p.value, headerTooltip: "What can be done to fix the issue"  },
                    { headerName: "Issue Type", field: "issue_type", filter: "agTextColumnFilter", headerTooltip: "Type of the issue" },
                    { headerName: "Issue Row", field: "issue_row", filter: "agTextColumnFilter", headerTooltip: "Corresponding row no. in the CSV where the issue occured" },
                    { headerName: "Invalid Value", field: "invalid_value" , filter: "agTextColumnFilter", headerTooltip: "Invalid Value" },
                    { headerName: "Disposition", field: "disposition", filter: "agTextColumnFilter", headerTooltip: "If this file passed with a 'WARNING' error and generated the FHIR JSON or got a 'REJECTION' and the FHIR did not get generated" },
                    { headerName: "Session ID", field: "session_id", filter: "agTextColumnFilter", headerTooltip: "Session ID" },
                    { headerName: "Issue ID", field: "orch_session_issue_id", filter: "agNumberColumnFilter", headerTooltip: "Issue ID" }
                ])
                .withServerSideDatasource(
                    window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewName}.json`),
                    (data, valueCols) => {
                        return valueCols.map(col => ({
                            headerName: col.displayName,
                            field: col.field
                        }));
                    },
                )
                .withModalAide(modalAide)
                .withGridDivStyles({ height: "750px", width: "100%" })
                .build();

            agGridInstance.init('serverDataGrid');
        });
    </script>    
</head>

<body>
    <div layout:fragment="content">
        <div id="serverDataGrid" class="ag-theme-alpine"></div>
    </div>
</body>

</html>