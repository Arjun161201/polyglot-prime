<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/prime}">

<head>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css">

    <!-- if JSON Viewer is not already in the layout, add the following -->
    <!-- <script src="https://unpkg.com/@alenaksu/json-viewer@2.0.0/dist/json-viewer.bundle.js"></script> -->

    <script src="https://unpkg.com/ag-grid-enterprise/dist/ag-grid-enterprise.js"></script>
    <style>
        .grid-description {
            font-size: 14px;
            margin: 8px 0px 10px 15px;
        }
    </style>
    <script type="module">
        import { AGGridAide, AGGridAideBuilder } from '@presentation/shell/aggrid-aide.js';
        import ModalAide from '@presentation/shell/modal-aide.js';

        const schemaName    = 'techbd_udi_ingress';
        const viewName      = 'fhir_validation_issue';
        const igPublication = 'fhir_session_diagnostics';
        const igPublicationColumnDefs = [ 
            { headerName: "Issues", field: "issue", filter: "agTextColumnFilter"  } 
        ];
        function getIgPublicationGridData(params) {
            const hub_interaction_id = params.data.hub_interaction_id; 
            fetch(window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewName}/hub_interaction_id/${hub_interaction_id}.json`))
                .then(response => response.json())
                .then(response => {
                    params.successCallback(response);
                })
                .catch(error => {
                    console.error('Error fetching details data' + error);
                });
        }
        document.addEventListener('DOMContentLoaded', function () {
            const modalAide = new ModalAide();
            const agGridInstance = new AGGridAideBuilder()  
                .withColumnDefs([ 
                    { headerName: "Validation Engine", field: "validation_engine", filter: "agTextColumnFilter"  },
                    { headerName: "Issues", field: "issue", filter: "agTextColumnFilter"  } ,                    
                    { headerName: "Most Recent Date", field: "most_recent_date", filter: "agTextColumnFilter",    valueFormatter: AGGridAide.dateTimeValueFormatter(true) },
                    { headerName: "Count Of Interactions", field: "issue_count", filter: "agNumberColumnFilter"  } 
                ]) 
                .withMasterDetail(true)
                .withDetailCellRendererParams({
                   
                    
                    detailGridOptions: {
                        columnDefs: igPublicationColumnDefs,
                        defaultColDef: {
                            flex: 1
                        }
                    },
                    getDetailRowData: params => { 
                        getIgPublicationGridData(params);
                    }
                })
                .withServerSideDatasource(
                    window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewName}.json`),
                    (data, valueCols) => {
                        return valueCols.map(col => ({
                            headerName: col.displayName,
                            field: col.field
                        }));
                    },
                )
                .withMasterDetail(false)
                .withDetailCellRendererParams({
                    detailGridOptions: {
                        columnDefs: igPublicationColumnDefs,
                        defaultColDef: {
                            flex: 1
                        }
                    },
                    getDetailRowData: params => {
                        getIgPublicationGridData(params);
                    }
                })
                .withModalAide(modalAide)
                .withGridDivStyles({ height: "750px", width: "100%" })
                .build();

            agGridInstance.init('serverDataGrid');
        });
    </script>
</head>

<body>
    <div layout:fragment="content">
        <div class="grid-description" id="date-range"> 
            This widget provides a summary of IG (Implementation Guide) publication issues by displaying HTTP interactions that encountered validation problems. It shows the validation engine used, lists the specific issues detectedâ€”such as unknown profile references or unrecognized extensions, indicates the most recent validation date, and displays the count of interactions associated with each issue. Common issues include profiles that haven't been checked due to being unknown, and extensions or code systems that are not recognized. This information helps users quickly identify and resolve validation errors, ensuring that IG publications meet required standards and maintain data integrity.
        </div>       
        <div id="serverDataGrid" class="ag-theme-alpine"></div>
    </div>
</body>

</html>