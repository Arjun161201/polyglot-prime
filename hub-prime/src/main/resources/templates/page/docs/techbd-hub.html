<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/docs}">

<head>
    <script type="module">
        import { RenderableResource, RenderableResources, handleExternalRefErrors } from '@presentation/shell/renderable-resource.js';

        const isAbsoluteURL = url => { try { return new URL(url).origin !== 'null'; } catch { return false; } };
        const renderElemSupplier = () => document.getElementById('resource');
        window.rr = new RenderableResources(
            (resourceUrl) => window.shell.serverSideUrl(`/docs/techbd-hub/resource/content?path=${resourceUrl}`),
            renderElemSupplier,
            {
                markdownUrlRewriter: ((url) => {
                    if (!isAbsoluteURL(url))
                        console.warn(`A relative URL was encountered in Markdown but not rewritten`, { url });
                    return url;
                })
            }
        );
        document.addEventListener('DOMContentLoaded', window.rr.fromURI("docs/techbd-intro.md"));
        document.addEventListener(RenderableResource.RESOURCE_RENDERED_EVENT_NAME, async function (event) {
            const { resourceURI, resource } = event.detail;

            window.layout.title(resource.title);
            window.layout.breadcrumbs([...window.layout.activeRoute.breadcrumbs, ...resource.breadcrumbs], false);
            document.querySelectorAll('#sidebar a').forEach(a => a.classList.toggle('selected', a.getAttribute('href') == resourceURI));
            if (window.mermaid) await window.mermaid.run();

            // TODO: replace attempt-rewrite.png with something like 
            //       /docs/techbd-hub/resource/proxy/<path> which would proxy items from the source
            const targetElem = renderElemSupplier();
            handleExternalRefErrors(
                (providedSrc, target) => 'attempt-rewrite.png',
                { handleElement: element => targetElem.contains(element) });
        });
    </script>
    <script src='https://cdn.jsdelivr.net/npm/htmx.org@1.9.12/dist/htmx.min.js'></script>
    <title>TechBD Hub Documentation</title>
    <style>
        .selected {
            background-color: #f0f0f0;
        }

        .mermaid {
            background-color: #ffffff !important;
            color: #000000 !important;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        details[open] .caret {
            transform: rotate(90deg);
        }

        .caret {
            transition: transform 0.3s;
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="flex">
            <nav id="sidebar" class="w-1/4 p-4">
                <ul class="top-level space-y-2">
                    <li th:each="node : ${sidebarItems.root().children().get(1).children()}">
                        <div th:if="${node != null}" th:replace="~{this :: nodeFragment(${node}, 1)}"></div>
                    </li>
                </ul>

                <!-- 
                This fragment, `nodeFragment`, conditionally renders a tree node structure based on the presence and type of nodes.
                1. For non-leaf nodes:
                - A `<details>` element is rendered with a `<summary>` displaying the node's caption.
                - If the node has a payload, an `<a>` tag is rendered with:
                    - `href` attribute set to the node's absolute path.
                    - `data-resource-path` attribute set to the node's absolute path.
                    - `data-resource-mime-type` attribute conditionally set based on the node's payload.
                    - An `onclick` event that prevents default navigation and calls `window.rr.fromURI` with the node's href.
                - If the node does not have a payload, a `<span>` tag is rendered displaying the node's caption.
                - A `<svg>` caret icon is included in the `<summary>`.
                - Child nodes are recursively rendered within `<ul>` and `<li>` elements.
                2. For leaf nodes:
                - An `<a>` tag is always rendered with:
                    - `href` attribute set to the node's absolute path.
                    - `data-resource-path` attribute set to the node's absolute path.
                    - `data-resource-mime-type` attribute conditionally set based on the node's payload.
                    - An `onclick` event that prevents default navigation and calls `window.rr.fromURI` with the node's href.
                -->
                <div th:fragment="nodeFragment(node, level)">
                    <details th:if="${node != null and !node.isLeaf()}" class="w-full" open>
                        <summary class="flex items-center justify-between w-full py-1 cursor-pointer">
                            <div class="group-label flex items-center">
                                <div th:if="${node.payload().isPresent()}">
                                    <a th:href="${node.absolutePath()}" th:text="${sidebarNS.caption(node)}"
                                        class="text font-semibold" th:attr="data-resource-path=${node.absolutePath()}"
                                        th:attrappend="data-resource-mime-type=${node.payload().get().resource().nature().mimeType()}"
                                        onclick="event.preventDefault(); window.rr.fromURI(event.target.getAttribute('href'));"></a>
                                </div>
                                <div th:if="${!node.payload().isPresent()}">
                                    <span th:text="${sidebarNS.caption(node)}" class="text font-semibold"></span>
                                </div>
                            </div>
                            <svg aria-hidden="true" class="caret w-4 h-4 flex-none" fill="currentColor">
                                <path
                                    d="M14.83 11.29L10.59 7.05a1 1 0 00-1.42 1.42L12.71 12l-3.54 3.54a1 1 0 001.42 1.42l4.24-4.24a1 1 0 000-1.42z">
                                </path>
                            </svg>
                        </summary>
                        <ul class="pl-4 border-l border-gray-300">
                            <li th:each="child : ${node.children()}" class="relative">
                                <div th:if="${child != null}"
                                    th:replace="~{this :: nodeFragment(${child}, ${level + 1})}">
                                    <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-gray-300"></div>
                                </div>
                            </li>
                        </ul>
                    </details>
                    <div th:if="${node != null and node.isLeaf()}">
                        <a th:href="${node.absolutePath()}" th:text="${sidebarNS.caption(node)}" class="text-gray-800"
                            th:attr="data-resource-path=${node.absolutePath()}"
                            th:attrappend="data-resource-mime-type=${node.payload().isPresent() ? node.payload().get().resource().nature().mimeType() : null}"
                            onclick="event.preventDefault(); window.rr.fromURI(event.target.dataset.resourcePath);"></a>
                    </div>
                </div>
            </nav>

            <div class="w-3/4 p-4 prose max-w-none">
                <header>
                    <h1 id="heading-prime">
                        <!-- Primary Heading (usually page title) -->
                    </h1>
                </header>
                <div id="resource">
                    <!-- Resource content is inserted dynamically when the sidebar menu items are tapped -->
                </div>
            </div>
        </div>
    </div>
</body>

</html>